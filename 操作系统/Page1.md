### 操作系统的特征

#### 并发

并发是指两个或者多个事件在同一时间间隔内发生。这些事件在**宏观**上是同时发生的，但是微观上是**交替**发生的。

PS.并行：是指两个或者多个事件在同一时刻同时发生

什么是操作系统的并发性：

在计算机当中“同时”运行着多个程序，这些程序宏观上是同时运行的，但是在微观上是交替运行的。

**注意：**单核CPU同一时刻只能运行一个程序，各个程序只能并发地执行；而多核CPU同一时刻可以同时执行多个程序，多个程序可以并行地执行。

#### 共享

共享即资源共享，是指系统中的资源可供内存中多个并发执行的进程共同使用。

##### 两种资源贡献方式

-   互斥共享方式（系统中的某些资源，虽然可以提供给多个进程使用，但一个时间段内只能允许一个进程访问该资源）例如：摄像头只能被一个程序所使用的。
-   同时共享方式（系统中的某些资源，允许一个时间段内由多个进程“同时”对他们进行访问）

#### 并发和共享之间的关系

如果失去并发性，则系统中只有一个程序正在运行，则共享性失去存在的意义，如果失去共享性，则两个甚至多个程序不能够同时访问硬盘资源，则无法实现同时读取发送文件，也就无法并发。故并发和共享互为存在条件

#### 虚拟

虚拟是把一个物理上的实体变为若干个逻辑上的对应物。物理实体是实际存在的，而逻辑上对应物是用户感受到的。

虚拟技术：

-   空分复用技术（如虚拟存储器技术）
-   时分复用技术（如虚拟处理器）

**没有并发性就谈不上虚拟性**

#### 异步

异步是指，在多道程序环境下，允许多个程序并发执行，但是由于资源有限，进程的执行不是一贯到底的，而是走走停停的，以不可预知的速度向前推进这就是进程的异步性。

PS 如果系统失去了并发性，则系统只能串行地运行各个程序，那么每个程序的执行会一管到底。**只有系统拥有并发性，才可能导致异步性。**

### 操作系统的发展历史和分类

#### 手工操作阶段

这个阶段采用的是纸带机的方法

主要缺点：用户独占全机、人机速度矛盾导致资源利用率极低

#### 批处理阶段——单道批处理系统

引入脱机输入/输出技术（用外围机+磁带完成），并有监督程序负责控制作业的输入输出

主要优点：缓解了一定程度的人机速度矛盾，资源利用率有所提升

主要缺点：内存中仅能有一道程序运行，只有该程序结束之后才能调入下一道程序。CPU有大量的时间是在空闲等待I/O完成，资源利用率依然很低。

#### 批处理阶段——多道批处理系统

操作系统正式诞生，用于支持多道程序并发执行。

主要优点：多道程序并发执行，共享计算机资源。资源利用率大幅度提升，CPU和其他资源更能保持“忙碌”状态，系统吞吐量增大

主要缺点：用户响应时间长，没有人机交互功能（用户提交自己的作业之后就只能等待计算机处理完成，中间不能控制自己的作业执行。无法调试程序/无法在程序的运行过程中输入一些参数）

#### 分时操作系统

分时操作系统：计算机以时间片为单位轮流为各个用户/作业服务，各个用户可通过终端与计算机进行交互。

主要优点：用户请求可以被及时响应，解决了人机交互的问题。允许多个用户使用一台计算机，并且用户对计算机的操作互相独立，感受不到别人的存在。

主要缺点：不能优先处理一些紧急任务。

#### 实时操作系统

主要优点：能够优先响应一些紧急任务，某些紧急任务不需要时间片排队。

在实时操作系统的控制之下，计算机系统就收到外部信号后及时进行处理，并且要在严格的时限内处理完事件。实时操作系统的主要特点是及时性和可靠性

实时操作系统：

-   硬实时系统：必须在绝对严格的规定时间内完成处理（导弹控制系统、自动驾驶系统）
-   软实时系统：能接受偶尔违反时间规定（12306火车订票系统）

### 操作系统的运行机制

指令就是处理器能够识别、执行的最基本命令

内核程序V.S.应用程序

内核是操作系统最重要最核心的部分，也是最接近硬件的部分。内核由很多内核程序组成了“操作系统内核”

>   ### 操作系统的运行机制
>
>   >   预备知识：程序是如何运行的
>
>   #### 内核程序和应用程序
>
>   很多由内核程序组成的操作系统内核，简称为内核(Kernel)
>
>   内核是操作系统最核心最重要的部分，也是最接近硬件的部分
>
>   且操作系统的功能未必都在内核中，例如图形化用户界面GUI
>
>   **操作系统有时候会让CPU执行一些“特权指令”，而应用程序只能使用“非特权指令”**
>
>   在CPU设计和生产的时候就划分了特权指令和非特权指令
>
>   ##### Q:CPU如何判断此时正在运行的是内核程序还是应用程序？
>
>   A：CPU有两种状态，“内核态”和“用户态”
>
>   处于内核态时，说明此时正在运行的是内核程序，此时可以执行特权指令
>
>   处于用户态的时候，说明此时正在运行的是应用程序，此时只能执行非特权指令
>
>   PS：CPU会有一个寄存器叫做程序状态字寄存器（PSW），其中有二进制位表示状态。
>
>   #### Q：内核态和用户态的切换
>
>   A：刚开机的时候，CPU处于内核态，操作系统内核程序线上CPU运行，操作系统内核在让出CPU之前，会用一条特权指令把PSW的标志位设置为用户态。
>
>   如果在用户态的状态下使用特权指令的话，CPU会检测到此时的非法状态并且给出一个中断信号，当CPU检测到中断信号后，会立即转变为核心态，并且停止运行当前的应用程序，转而处理中断信号的内核程序。
>
>   中断使操作系统再次夺回了CPU的使用权。
>
>   **内核态→用户态：**执行一条特权指令——修改PSW的标志位为用户态，这个动作意味着操作系统将会主动让出CPU的使用权
>
>   **用户态→内核态：**由中断引发，硬件自动完成变态过程，触发中断信号意味着操作系统将强行夺回CPU的使用权。（PS：除了非法使用特权指令之外，还有很多事件会触发中断信号，一个共性是，但凡需要操作系统介入的地方，都会出发中断信号）

###  中断和异常

#### 中断的作用：

CPU上会运行两种程序，一种是操作系统的内核程序（整个系统的管理者），一种是应用程序。

中断是让操作系统内核夺回CPU使用权的唯一途径。“中断”会使CPU由用户态变为内核态，使操作系统重新夺回对CPU的控制权

PS：如果没有中断机制，那么一旦应用程序在CPU上运行，CPU就会一直运行这个应用程序

内核态→用户态：执行一条特权指令——修改PSW的标志位为“用户态”，这个动作意味着操作系统主动让出CPU的使用权

用户态→内核态：由“中断”引发，硬件自动完成变态过程，触发中断信号意味着操作系统将强行夺回CPU的使用权

#### 中断的类型：

-   内中断（与当前执行的指令有关，中断信号来源于CPU内部）也称异常、例外

    内中断的例子：

    1.  试图在用户态下执行特权指令
    2.  执行除法指令时候发现除数为0
    3.  有时候应用程序想请求操作系统内核的服务，此时会执行一条特殊的指令——陷入指令，该指令会引发一个内部中断的信号（执行“陷入指令”，意味着应用程序主动地将CPU的控制权还给操作系统内核，“系统调用”就是通过陷入指令完成的。

-   外中断（与当前执行的指令无关，中断信号来源于CPU外部）也称中断

    外中断的例子：

    1.  时钟中断——由时钟部件发来的中断信号
    2.  I/O中断——由输入/输出设备发来的中断信号

**判断内中断和外中断的方法只需要看此次中断是否与当前指令的执行有关**

#### 中断机制的基本原理

不同的中断信号，需要用不同的中断处理程序来处理。当CPU检测到中断信号后，会根据中断信号的类型去查询“中断向量表”，以此来找到相应的中断程序在内存中的存放位置。

### 系统调用

#### 系统调用与库函数的区别

有的库函数是包含系统调用的，而有的库函数是不包含库函数的。

>   为什么系统调用是必须的？
>
>   当我们在使用打印机的时候，存在着两个并行的打印程序发来的任务，如果两个进程可以随意的、并发的共享打印机的资源，那么这两个任务的内容就会混杂在一起。
>
>   那么解决的方法是：由操作系统内核对共享资源进行统一的管理，并向上提供“系统调用”，用户进程想使用打印机这种共享资源，只能通过系统调用的方法来向操作系统的内核发出请求。内核会对各个请求进行协调处理。

#### 系统调用（按照功能分类）

-   设备管理，完成设备的请求、释放、启动等等功能
-   文件管理，完成文件的读写、创建、删除等等功能
-   进程控制，完成进程的创建、撤销、阻塞、唤醒等功能
-   进程通信，完成进程之间的消息传递、信号传递等功能
-   内存管理，完成内存的分配、回收等功能

总之，凡是与贡献资源有关的操作（例如内存分配，I/O操作，文件管理），都必须通过系统调用的方式向操作系统内核提出服务请求，由操作系统内核代为完成。

这样的系统调用保证了系统的稳定性和安全性。

##### 系统调用的过程

传递系统调用参数→执行陷入指令（**用户态**）→执行相应的内核程序处理系统调用（**核心态**）→返回应用程序

注：

1.  陷入指令只在用户态执行的，执行陷入指令之后立即引发一个内中断，使CPU进入核心态
2.  发出系统调用请求是在用户态，而对系统调用的相应处理是在核心态下进行

### 操作系统的体系结构

![image-20220123171329729](C:\Users\hydro\AppData\Roaming\Typora\typora-user-images\image-20220123171329729.png)

内核中有：时钟管理、中断处理、原语（设备驱动、CPU切换等），进程管理、存储器管理，设备管理等功能。

原语：是一种特殊的程序，具有原子性，也就是说，这段程序的运行必须一气呵成，不可被中断。

**内核是操作系统最基本，最核心的部分。实现操作系统内核功能的程序就是内核程序**

![image-20220123190438036](C:\Users\hydro\AppData\Roaming\Typora\typora-user-images\image-20220123190438036.png)

大内核的变态需要的次数少，而微内核的变态需要的次数多。变态的过程是有成本的。

##### 大内核

-   优点：高性能
-   缺点：内核代码庞大，结构混乱，难以维护

##### 微内核

-   优点：内核功能少，结构清晰，方便维护
-   缺点：需要频繁地在核心态和用户态之间切换，性能低

典型的大内核：Linux、Unix

典型的微内核：Windows NT